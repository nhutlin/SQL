CREATE DATABASE QLBH

USE QLBH
-- I. Ngôn ngữ định nghĩa dữ liệu (Data Definition Language)
CREATE TABLE KHACHHANG
(
	MAKH CHAR(4) PRIMARY KEY,
	HOTEN VARCHAR(40),
	DCHI VARCHAR(50),
	SODT VARCHAR(20),
	NGSINH SMALLDATETIME,
	NGDK SMALLDATETIME,
	DOANHSO MONEY
)
CREATE TABLE NHANVIEN
(
	MANV CHAR(4) PRIMARY KEY,
	HOTEN VARCHAR(40),
	SODT VARCHAR(20),
	NGVL SMALLDATETIME
)
CREATE TABLE SANPHAM
(
	MASP CHAR(4) PRIMARY KEY,
	TENSP VARCHAR(20),
	DVT VARCHAR(20),
	NUOCSX VARCHAR(40),
	GIA MONEY
)
CREATE TABLE HOADON 
(
	SOHD INT PRIMARY KEY,
	NGHD SMALLDATETIME,
	MAKH CHAR(4) FOREIGN KEY REFERENCES KHACHHANG(MAKH),
	MANV CHAR(4) FOREIGN KEY REFERENCES NHANVIEN(MANV),
	TRIGIA MONEY
)
CREATE TABLE CTHD 
(
	SOHD INT FOREIGN KEY REFERENCES HOADON(SOHD),
	MASP CHAR(4) FOREIGN KEY REFERENCES SANPHAM(MASP),
	SL INT,
	CONSTRAINT PK_CTHD PRIMARY KEY(SOHD, MASP)
)

-- 2. Thêm vào thuộc tính GHICHU có kiểu dữ liệu varchar(20) cho quan hệ SANPHAM
ALTER TABLE SANPHAM ADD GHICHU VARCHAR(20)

-- 3. Thêm vào thuộc tính LOAIKH có kiểu dữ liệu là tinyint cho quan hệ KHACHHANG
ALTER TABLE KHACHHANG ADD LOAIKH TINYINT

-- 4. Sửa kiểu dữ liệu của thuộc tính GHICHU trong quan hệ SANPHAM thành varchar(100)
ALTER TABLE SANPHAM ALTER COLUMN GHICHU VARCHAR(100)

-- 5. Xóa thuộc tính GHICHU trong quan hệ SANPHAM
ALTER TABLE SANPHAM drop COLUMN GHICHU

-- 6. Làm thế nào để thuộc tính LOAIKH trong quan hệ KHACHHANG có thể lưu các giá trị là: “Vang lai”, “Thuong xuyen”, “Vip”, …
ALTER TABLE KHACHHANG ALTER COLUMN LOAIKH VARCHAR(100)

-- 7. Đơn vị tính của sản phẩm chỉ có thể là (“cay”,”hop”,”cai”,”quyen”,”chuc”)
ALTER TABLE SANPHAM ADD CONSTRAINT CK_DVT CHECK (DVT in ('cay', 'hop', 'quyen', 'chuc', 'cai')) 

-- 8. Giá bán của sản phẩm từ 500 đồng trở lên
ALTER TABLE SANPHAM ADD CONSTRAINT CK_GIA CHECK (GIA >= 500)

-- 9. Mỗi lần mua hàng, khách hàng phải mua ít nhất 1 sản phẩm
ALTER TABLE CTHD ADD CONSTRAINT CK_SL CHECK(SL >=1)

-- 10. Ngày khách hàng đăng ký là khách hàng thành viên phải lớn hơn ngày sinh của người đó
ALTER TABLE KHACHHANG ADD CONSTRAINT CK_NG CHECK(NGDK > NGSINH)

-- 11. Ngày mua hàng (NGHD) của một khách hàng thành viên 
--sẽ lớn hơn hoặc bằng ngày khách hàng đó đăng ký thành viên
--(NGDK)
CREATE TRIGGER TRG_INS_UPD_NGHD
ON HOADON
FOR INSERT, UPDATE
AS 
BEGIN
	IF(EXISTS(SELECT * 
			  FROM KHACHHANG KH, INSERTED
			  WHERE KH.MAKH = INSERTED.MAKH
			  AND KH.NGDK > INSERTED.NGHD
			  )
		)
	BEGIN
		PRINT 'Ngày mua hàng phải lớn hơn ngày đăng kí thành viên của khách hàng'
		ROLLBACK TRAN
	END
END

CREATE TRIGGER TRG_UPD_NGDK
ON KHACHHANG
FOR UPDATE 
AS 
BEGIN
	IF(EXISTS(SELECT *
			  FROM HOADON HD, INSERTED I
			  WHERE HD.MAKH = I.MAKH
			  AND HD.NGHD < I.NGDK
			  )
		)
	BEGIN
		PRINT 'Thao tác sửa ngày đăng kí phải nhỏ hơn ngày mua hàng'
		ROLLBACK TRAN
	END
END

-- 12. Ngày bán hàng (NGHD) của một nhân viên phải lớn hơn hoặc bằng ngày nhân viên đó vào làm
CREATE TRIGGER TRG_UPD_NV
ON NHANVIEN
FOR UPDATE 
AS
BEGIN
	IF(EXISTS(SELECT *
			  FROM HOADON HD, INSERTED I
			  WHERE HD.MANV = I.MANV
			  AND HD.NGHD < I.NGVL
			  )
		)
	BEGIN
		PRINT 'Thao tác sửa ngày vào làm phải bé hơn ngày bán hàng của nhân viên'
		ROLLBACK TRAN
	END
END

CREATE TRIGGER TRG_INS_UPD_HD
ON HOADON
FOR INSERT, UPDATE
AS
BEGIN
	IF(EXISTS(SELECT *
			  FROM NHANVIEN NV, INSERTED I
			  WHERE NV.MANV = I.MANV
			  AND NV.NGVL > I.NGHD
			  )
		)
	BEGIN
		PRINT 'Ngày mua hàng của một nhân viên phải lớn hơn hoặc bằng ngày nhân viên đó vào làm' 
	END
END

-- 13. Mỗi một hóa đơn phải có ít nhất một chi tiết hóa đơn
CREATE TRIGGER TRG_DEL_CTHD
ON CTHD
FOR DELETE 
AS
BEGIN
	IF((SELECT COUNT(*)
	   FROM DELETED D
	   WHERE SOHD = D.SOHD
	   ) = (SELECT COUNT(*)
			FROM HOADON HD, DELETED
			WHERE HD.SOHD = DELETED.SOHD)
		)
	BEGIN
		PRINT 'Mỗi một hóa đơn phải có ít nhất một chi tiết hóa đơn'
		ROLLBACK TRAN
	END
END

-- 14. Trị giá của một hóa đơn là tổng thành tiền (số lượng*đơn giá) của các chi tiết thuộc hóa đơn đó
CREATE TRIGGER TRG_INS_TRIGIA_CTHD
ON CTHD 
FOR INSERT 
AS 
	DECLARE @SOHD INT, @TRIGIATHEM MONEY
	SET @TRIGIATHEM = 0

	SELECT @SOHD = SOHD, @TRIGIATHEM = SL * GIA 
    FROM INSERTED I, SANPHAM SP
    WHERE I.MASP = SP.MASP
	BEGIN 
		UPDATE HOADON 
		SET TRIGIA = TRIGIA + @TRIGIATHEM 
		WHERE SOHD = @SOHD	
		PRINT 'Thêm CTHD thành công và đã cập nhật lại trị giá '
	END

CREATE TRIGGER TRG_DEL_TRIGIA_CTHD
ON CTHD
FOR DELETE
AS
	DECLARE @SOHD INT, @TRIGIABBIMAT MONEY
	SET @TRIGIABBIMAT = 0
	SELECT @SOHD = SOHD, @TRIGIABBIMAT = D.SL * GIA 
    FROM DELETED D, SANPHAM 
    WHERE D.MASP = SANPHAM.MASP
BEGIN
	UPDATE HOADON
	SET TRIGIA = TRIGIA - @TRIGIABBIMAT
	WHERE SOHD = @SOHD
	PRINT 'Xóa CTHD thành công và đã cập nhật lại trị giá'
END

CREATE TRIGGER TRG_UPD_TRIGIA_CTHD
ON CTHD 
FOR UPDATE 
AS
	DECLARE @SOHD INT, @TRIGIABBIMAT MONEY, @TRIGIAMOITHAYDOI MONEY
	SET @TRIGIABBIMAT = 0
	SET @TRIGIAMOITHAYDOI = 0

	SELECT @SOHD = SOHD, @TRIGIABBIMAT = D.SL * GIA 
    FROM DELETED D, SANPHAM SP 
    WHERE D.MASP = SP.MASP 

	SELECT @SOHD = SOHD, @TRIGIAMOITHAYDOI = I.SL * GIA 
    FROM INSERTED I, SANPHAM 
    WHERE I.MASP = SANPHAM.MASP 
	BEGIN
		UPDATE HOADON
		SET TRIGIA = TRIGIA - @TRIGIABBIMAT + @TRIGIAMOITHAYDOI
		WHERE SOHD = @SOHD
		PRINT 'Cập nhật CTHD và trị giá thành công'
	END

CREATE TRIGGER TRG_UPD_TRIGIA_HOADON
ON HOADON
FOR UPDATE
AS
	IF UPDATE (TRIGIA)
	BEGIN
		DECLARE @TONGTRIGIACU MONEY, @TRIGIAMOI MONEY
		SET @TONGTRIGIACU = 0

		SELECT @TRIGIAMOI = TRIGIA 
        FROM INSERTED 

		SELECT @TONGTRIGIACU = SUM(SL * GIA) 
							   FROM CTHD, SANPHAM SP, INSERTED 
							   WHERE INSERTED.SOHD = CTHD.SOHD 
                               AND SP.MASP = CTHD.MASP
		IF (@TRIGIAMOI <> @TONGTRIGIACU)
		BEGIN
			PRINT 'Trị giá mới không bằng với trị giá cũ'
			ROLLBACK TRAN
		END
	END 

-- 15. Doanh số của một khách hàng là tổng trị giá các hóa đơn mà khách hàng thành viên đó đã mua
CREATE TRIGGER TRG_UPD_KHACHHANG
ON KHACHHANG
FOR UPDATE
AS
BEGIN
	DECLARE @TONGTRIGIA MONEY, @DOANHSO MONEY

	SELECT @TONGTRIGIA = SUM(TRIGIA)
	FROM INSERTED I, HOADON HD
	WHERE I.MAKH = HD.MAKH

	SELECT @DOANHSO = DOANHSO
	FROM INSERTED 

	IF(@TONGTRIGIA <> @DOANHSO)
	BEGIN
		PRINT 'Doanh số của một khách hàng là tổng trị giá các hóa đơn mà khách hàng thành viên đó đã mua'
		ROLLBACK TRAN
	END
END


-- II. Ngôn ngữ thao tác dữ liệu (Data Manipulation Language)
-- Nhập dữ liệu cho các quan hệ trên
SET DATEFORMAT DMY
SELECT * FROM KHACHHANG
SELECT * FROM NHANVIEN
INSERT INTO NHANVIEN (MANV, HOTEN, SODT, NGVL) VALUES ('NV01', 'Nguyen Nhu Nhut', '0927345678', '13/4/2006')
INSERT INTO NHANVIEN (MANV, HOTEN, SODT, NGVL) VALUES ('NV02', 'Le Thi Phi Yen', '0987567390', '21/4/2006')
INSERT INTO NHANVIEN (MANV, HOTEN, SODT, NGVL) VALUES ('NV03', 'Nguyen Van B', '0997047382', '27/4/2006')
INSERT INTO NHANVIEN (MANV, HOTEN, SODT, NGVL) VALUES ('NV04', 'Ngo Thanh Tuan', '0913758498', '24/6/2006')
INSERT INTO NHANVIEN (MANV, HOTEN, SODT, NGVL) VALUES ('NV05', 'Nguyen Thi Truc Thanh', '0918590387', '20/7/2006')

INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH01', 'Nguyen Van A', '731, Tran Hung Dao, Q5, TPHCM', '08823451', '22/10/1960', 13060000, '22/07/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH02', 'Tran Ngoc Han', '23/5 Nguyen Trai, Q5, TpHCM', '0908256478', '03/04/1974', 280000, '30/07/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH03', 'Tran Ngoc Linh', '45 Nguyen Canh Chan, Q1, TpHCM', '0938776266', '12/06/1980', 3860000, '05/08/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH04', 'Tran Minh Long', '50/34 Le Dai hanh, Q10, TpHCM', '0917325476', '09/03/1965', 250000, '02/10/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH05', 'Le Nhat Minh', '34 Truong Dinh, Q3, TPHCM', '08246108', '10/03/1960', 21000, '28/10/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH06', 'Le Hoai Thuong', '227 Nguyen Van Cu, Q5, TpHCM', '08631738', '31/12/1981', 915000, '24/11/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH07', 'Nguyen Van Tam', '32/3 Tran Binh Trong, Q5, TpHCM', '0916783565', '06/04/1971', 12500, '01/12/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH08', 'Phan Thi Thanh', '45/2 An Duong Vuong, Q5, TPHCM', '0938435756', '10/01/1971', 365000, '13/12/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH09', 'Le Ha Vinh', '873 Le Hong Phong, Q5, TPHCM', '08654763', '03/09/1979', 70000, '14/01/2007')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH10', 'Ha Duy Lap', '34/34B Nguyen Trai, Q1, TPHCM', '08768904', '02/05/1963', 67500, '16/01/2007')

INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BC01', 'But Chi', 'cay', 'Singapore', 3000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BC02', 'But Chi', 'cay', 'Singapore', 5000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BC03', 'But Chi', 'cay', 'Viet Nam', 3500)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BC04', 'But Chi', 'hop', 'Viet Nam', 30000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BB01', 'But bi', 'cay', 'Viet Nam', 5000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BB02', 'But bi', 'cay', 'Trung Quoc', 7000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BB03', 'But bi', 'hop', 'Thai Lan', 100000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV01', 'Tap 100 giay mong', 'quyen', 'Trung Quoc', 2500)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV02', 'Tap 200 giay mong', 'quyen', 'Trung Quoc', 4500)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV03', 'Tap 100 giay tot', 'quyen', 'Viet Nam', 3000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV04', 'Tap 200 giay tot', 'quyen', 'Viet Nam', 5500)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV05', 'Tap 100 trang', 'chuc', 'Viet Nam', 23000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV06', 'Tap 200 trang', 'chuc', 'Viet Nam', 53000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV07', 'Tap 100 trang', 'chuc', 'Trung Quoc', 34000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST01', 'So tay 500 trang', 'quyen', 'Trung Quoc', 40000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST02', 'So tay loai 1', 'quyen', 'Viet Nam', 55000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST03', 'So tay loai 2', 'quyen', 'Viet Nam', 51000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST04', 'So tay', 'quyen', 'Thai Lan', 55000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST05', 'So tay mong', 'quyen', 'Thai Lan', 20000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST06', 'Phan viet bang', 'hop', 'Viet Nam', 5000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST07', 'Phan khong bui', 'hop', 'Viet Nam', 5000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST08', 'Bong bang', 'cai', 'Viet Nam', 1000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST09', 'But long', 'cay', 'Viet Nam', 5000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST10', 'But long', 'cay', 'Trung Quoc', 7000)

INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1001, '23/07/2006', 'KH01', 'NV01', 320000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1002, '12/08/2006', 'KH02', 'NV02', 840000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1003, '23/08/2006', 'KH02', 'NV01', 100000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1004, '01/09/2006', 'KH02', 'NV01', 180000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1005, '20/10/2006', 'KH01', 'NV02', 3800000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1006, '16/10/2006', 'KH01', 'NV03', 2430000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1007, '28/10/2006', 'KH03', 'NV03', 510000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1008, '28/10/2006', 'KH01', 'NV03', 440000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1009, '28/10/2006', 'KH03', 'NV04', 200000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1010, '01/11/2006', 'KH01', 'NV01', 5200000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1011, '04/11/2006', 'KH04', 'NV03', 250000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1012, '30/11/2006', 'KH05', 'NV03', 21000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1013, '12/12/2006', 'KH06', 'NV01', 5000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1014, '31/12/2006', 'KH03', 'NV02', 3150000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1015, '01/01/2007', 'KH06', 'NV01', 910000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1016, '01/01/2007', 'KH07', 'NV02', 12500)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1017, '02/01/2007', 'KH08', 'NV03', 35000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1018, '13/01/2007', 'KH08', 'NV03', 330000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1019, '13/01/2007', 'KH01', 'NV03', 30000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1020, '14/01/2007', 'KH09', 'NV04', 70000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1021, '16/01/2007', 'KH10', 'NV03', 67500)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1022, '16/01/2007', NULL, 'NV03', 7000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1023, '17/01/2007', NULL, 'NV01', 330000)

INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1001, 'TV02', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1001, 'ST01', 5)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1001, 'BC01', 5)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1001, 'BC02', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1001, 'ST08', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1002, 'BC04', 20)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1002, 'BB01', 20)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1002, 'BB02', 20)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1003, 'BB03', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1004, 'TV01', 20)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1004, 'TV02', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1004, 'TV03', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1004, 'TV04', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1005, 'TV05', 50)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1005, 'TV06', 50)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1006, 'TV07', 20)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1006, 'ST01', 30)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1006, 'ST02', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1007, 'ST03', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1008, 'ST04', 8)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1009, 'ST05', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1010, 'TV07', 50)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1010, 'ST07', 50)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1010, 'ST08', 100)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1010, 'ST04', 50)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1010, 'TV03', 100)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1011, 'ST06', 50)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1012, 'ST07', 3)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1013, 'ST08', 5)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1014, 'BC02', 80)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1014, 'BB02', 100)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1014, 'BC04', 60)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1014, 'BB01', 50)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1015, 'BB02', 30)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1015, 'BB03', 7)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1016, 'TV01', 5)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1017, 'TV02', 1)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1017, 'TV03', 1)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1017, 'TV04', 5)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1018, 'ST04', 6)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1019, 'ST05', 1)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1019, 'ST06', 2)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1020, 'ST07', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1021, 'ST08', 5)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1021, 'TV01', 7)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1021, 'TV02', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1022, 'ST07', 1)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1023, 'ST04', 6)

-- Tạo quan hệ SANPHAM1 chứa toàn bộ dữ liệu của quan hệ SANPHAM. Tạo quan hệ KHACHHANG1 chứa toàn bộ dữ liệu của quan hệ KHACHHANG
SELECT * INTO SANPHAM1 FROM SANPHAM
SELECT * INTO KHACHHANG1 FROM KHACHHANG

-- Cập nhật giá tăng 5% đối với những sản phẩm do “Thai Lan” sản xuất (cho quan hệ SANPHAM1)
UPDATE SANPHAM1 SET GIA = GIA * 1.05 WHERE NUOCSX = 'Thai Lan'

-- Cập nhật giá giảm 5% đối với những sản phẩm do “Trung Quoc” sản xuất có giá từ 10.000 trở xuống (cho quan hệ SANPHAM1)
UPDATE SANPHAM1 SET GIA = GIA * 0.95 WHERE (NUOCSX = 'Trung Quoc' AND GIA < 10000)

-- Cập nhật giá trị LOAIKH là “Vip” đối với những khách hàng đăng ký thành viên trước ngày 1/1/2007 có doanh số từ 10.000.000 trở lên 
--hoặc khách hàng đăng ký thành viên từ 1/1/2007 trở về sau có doanh số từ 2.000.000 trở lên (cho quan hệ KHACHHANG1)
UPDATE KHACHHANG1 SET LOAIKH = 'Vip' WHERE (NGDK < '01/01/2007' AND DOANHSO >= 10000000) OR (NGDK >= '01/01/2007' AND DOANHSO >= 2000000)

-- III. Ngôn ngữ truy vấn dữ liệu có cấu trúc
-- In ra danh sách các sản phẩm (MASP,TENSP) do “Trung Quoc” sản xuất
SELECT MASP, TENSP 
FROM SANPHAM 
WHERE NUOCSX = 'Trung Quoc'

-- In ra danh sách các sản phẩm (MASP, TENSP) có đơn vị tính là “cay”, ”quyen”
SELECT MASP, TENSP 
FROM SANPHAM 
WHERE (DVT = 'cay' OR DVT = 'quyen')

--In ra danh sách các sản phẩm (MASP,TENSP) có mã sản phẩm bắt đầu là “B” và kết thúc là “01”
SELECT MASP, TENSP 
FROM SANPHAM 
WHERE (LEFT(MASP,1) = 'B' AND RIGHT(MASP, 2) = '01')

-- In ra danh sách các sản phẩm (MASP,TENSP) do “Trung Quốc” sản xuất có giá từ 30.000 đến 40.000
SELECT MASP, TENSP 
FROM SANPHAM 
WHERE (NUOCSX = 'Trung Quoc' AND (GIA >= 30000 AND GIA <= 40000))

-- In ra các số hóa đơn, trị giá hóa đơn bán ra trong ngày 1/1/2007 và ngày 2/1/2007
SELECT SOHD, TRIGIA 
FROM HOADON
WHERE (NGHD >= '01/01/2007' AND NGHD <= '01/02/2007')

-- In ra các số hóa đơn, trị giá hóa đơn trong tháng 1/2007, sắp xếp theo ngày (tăng dần) và trị giá của hóa đơn (giảm dần)
SELECT SOHD, TRIGIA
FROM HOADON
WHERE (MONTH(NGHD) = 1 AND YEAR(NGHD) = 2007)
ORDER BY NGHD ASC, TRIGIA DESC

-- Câu 8 - 17 
-- 8. In ra danh sách các khách hàng (MAKH, HOTEN) đã mua hàng trong ngày 1/1/2007
SELECT KHACHHANG.MAKH, HOTEN 
FROM KHACHHANG, HOADON
WHERE KHACHHANG.MAKH = HOADON.MAKH AND NGHD = '1/1/2007'

-- SELECT SOHD, HOTEN 
-- FROM HOADON LEFT JOIN KHACHHANG 
-- ON HOADON.MAKH = KHACHHANG.MAKH

-- SELECT COUNT(distinct MAKH) SL 
-- FROM HOADON

-- SELECT SOHD
-- FROM CTHD
-- WHERE MASP = 'BB02'
-- EXCEPT
-- SELECT SOHD
-- FROM CTHD
-- WHERE MASP = 'BB01'

-- 9. In ra số hóa đơn, trị giá các hóa đơn do nhân viên có tên “Nguyen Van B” lập trong ngày 28/10/2006
SELECT SOHD, TRIGIA
FROM HOADON, NHANVIEN 
WHERE NHANVIEN.MANV = HOADON.MANV AND HOTEN = 'Nguyen Van B' AND NGHD = '28/10/2006'

-- 10. In ra danh sách các sản phẩm (MASP,TENSP) được khách hàng có tên “Nguyen Van A” mua trong tháng 10/2006
SELECT DISTINCT SANPHAM.MASP, TENSP
FROM SANPHAM, CTHD, KHACHHANG, HOADON
WHERE CTHD.MASP = SANPHAM.MASP
	  AND CTHD.SOHD = HOADON.SOHD
	  AND KHACHHANG.MAKH = HOADON.MAKH
	  AND HOTEN = 'Nguyen Van A'
	  AND MONTH(NGHD) = 10 AND YEAR(NGHD) = 2006

-- 11. Tìm các số hóa đơn đã mua sản phẩm có mã số “BB01” hoặc “BB02”
SELECT DISTINCT SOHD
FROM CTHD
WHERE MASP IN ('BB01', 'BB02')

-- 12. Tìm các số hóa đơn đã mua sản phẩm có mã số “BB01” hoặc “BB02”, mỗi sản phẩm mua với số lượng từ 10 đến 20
SELECT DISTINCT SOHD
FROM CTHD
WHERE (MASP IN ('BB01', 'BB02')) AND (SL BETWEEN 10 AND 20)


-- 13. Tìm các số hóa đơn mua cùng lúc 2 sản phẩm có mã số “BB01” và “BB02”, mỗi sản phẩm mua với số lượng từ 10 đến 20
SELECT DISTINCT SOHD
FROM CTHD
WHERE MASP = 'BB01' AND SL BETWEEN 10 AND 20
INTERSECT
(
	SELECT DISTINCT SOHD
	FROM CTHD
	WHERE MASP = 'BB02' AND SL BETWEEN 10 AND 20
)

-- 14. In ra danh sách các sản phẩm (MASP,TENSP) do “Trung Quoc” sản xuất hoặc các sản phẩm được bán ra trong ngày 1/1/2007
SELECT DISTINCT SANPHAM.MASP, TENSP
FROM SANPHAM, HOADON, CTHD
WHERE SANPHAM.MASP = CTHD.MASP
	  AND CTHD.SOHD = HOADON.SOHD
	  AND (NUOCSX = 'Trung Quoc' OR NGHD = '1/1/2007')

-- 15. In ra danh sách các sản phẩm (MASP,TENSP) không bán được
SELECT MASP, TENSP
FROM SANPHAM
WHERE MASP NOT IN 
(
	SELECT MASP
	FROM CTHD
)

-- 16. In ra danh sách các sản phẩm (MASP,TENSP) không bán được trong năm 2006
SELECT MASP, TENSP
FROM SANPHAM
WHERE MASP NOT IN 
(
	SELECT MASP
	FROM CTHD, HOADON
	WHERE CTHD.SOHD = HOADON.SOHD 
	AND YEAR(NGHD) = 2006
)

-- 17. In ra danh sách các sản phẩm (MASP,TENSP) do “Trung Quoc” sản xuất không bán được trong năm 2006
SELECT MASP, TENSP
FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc' AND MASP NOT IN 
(
	SELECT MASP
	FROM CTHD, HOADON
	WHERE CTHD.SOHD = HOADON.SOHD
	AND YEAR(NGHD) = 2006
)

-- Câu 18-19  27-45 
-- 18. Tìm số hóa đơn đã mua tất cả các sản phẩm do Singapore sản xuất
SELECT SOHD
FROM HOADON
WHERE NOT EXISTS 
(
	SELECT *
	FROM SANPHAM
	WHERE NUOCSX = 'Singapore'
		  AND NOT EXISTS  (SELECT *
							FROM CTHD
							WHERE SANPHAM.MASP = CTHD.MASP
								  AND CTHD.SOHD = HOADON.SOHD)
)
-- 19. Tìm số hóa đơn trong năm 2006 đã mua ít nhất tất cả các sản phẩm do Singapore sản xuất
SELECT SOHD 
FROM HOADON
WHERE YEAR(NGHD) = 2006
AND NOT EXISTS (SELECT *
				FROM SANPHAM
				WHERE NUOCSX = 'Singapore'
				AND NOT EXISTS (SELECT *
								FROM CTHD
								WHERE CTHD.MASP = SANPHAM.MASP
								AND CTHD.SOHD = HOADON.SOHD
				)
)

-- 27. In ra danh sách 3 khách hàng (MAKH, HOTEN) có doanh số cao nhất
SELECT TOP 3 MAKH, HOTEN
FROM KHACHHANG
ORDER BY DOANHSO DESC

-- 28. In ra danh sách các sản phẩm (MASP, TENSP) có giá bán bằng 1 trong 3 mức giá cao nhất
SELECT MASP, TENSP
FROM SANPHAM
WHERE GIA IN (SELECT DISTINCT TOP 3 WITH TIES GIA
				FROM SANPHAM
				ORDER BY GIA DESC
				)

-- 29. In ra danh sách các sản phẩm (MASP, TENSP) do “Thai Lan” sản xuất có giá bằng 1 trong 3 mức giá cao nhất (của tất cả các sản phẩm)
SELECT MASP, TENSP
FROM SANPHAM
WHERE NUOCSX = 'Thai Lan'
AND GIA IN (SELECT DISTINCT TOP 3 GIA
			FROM SANPHAM
			ORDER BY GIA DESC
			)

-- 30. In ra danh sách các sản phẩm (MASP, TENSP) do “Trung Quoc” sản xuất có giá bằng 1 trong 3 mức giá cao nhất (của sản phẩm do “Trung Quoc” sản xuất)
SELECT MASP, TENSP
FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc'
AND GIA IN (SELECT DISTINCT TOP 3 GIA 
			FROM SANPHAM
			WHERE NUOCSX = 'Trung Quoc'
			ORDER BY GIA DESC
			)

-- 31. In ra danh sách 3 khách hàng có doanh số cao nhất (sắp xếp theo kiểu xếp hạng)
SELECT TOP 3 *
FROM KHACHHANG
ORDER BY DOANHSO DESC

-- 32. Tính tổng số sản phẩm do “Trung Quoc” sản xuất
SELECT COUNT(*) TONGSP
FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc'

-- 33. Tính tổng số sản phẩm của từng nước sản xuất
SELECT NUOCSX, COUNT(*) TONGSP
FROM SANPHAM
GROUP BY NUOCSX

-- 34. Với từng nước sản xuất, tìm giá bán cao nhất, thấp nhất, trung bình của các sản phẩm
SELECT NUOCSX, MAX(GIA) GIACAONHAT, MIN(GIA) GIATHAPNHAT, AVG(GIA) GIATRUNGBINH
FROM SANPHAM
GROUP BY NUOCSX

-- 35. Tính doanh thu bán hàng mỗi ngày
SELECT NGHD, SUM(TRIGIA) DOANHTHU
FROM HOADON
GROUP BY NGHD

-- 36. Tính tổng số lượng của từng sản phẩm bán ra trong tháng 10/2006
SELECT SP.MASP, SP.TENSP, SUM(SL) TONGSL
FROM SANPHAM SP, CTHD, HOADON
WHERE SP.MASP = CTHD.MASP
AND	HOADON.SOHD = CTHD.SOHD
AND MONTH(NGHD) = 10
AND	YEAR(NGHD) = 2006
GROUP BY SP.MASP, SP.TENSP

-- 37. Tính doanh thu bán hàng của từng tháng trong năm 2006
SELECT MONTH(NGHD) THANG, SUM(TRIGIA) DOANHTHU
FROM HOADON
WHERE YEAR(NGHD) = 2006
GROUP BY MONTH(NGHD)

-- 38. Tìm hóa đơn có mua ít nhất 4 sản phẩm khác nhau
SELECT SOHD
FROM CTHD 
GROUP BY SOHD
HAVING COUNT(DISTINCT MASP) >= 4

-- 39. Tìm hóa đơn có mua 3 sản phẩm do “Viet Nam” sản xuất (3 sản phẩm khác nhau)
SELECT SOHD
FROM CTHD, SANPHAM SP
WHERE CTHD.MASP = SP.MASP
AND NUOCSX = 'Viet Nam'
GROUP BY SOHD
HAVING COUNT(DISTINCT CTHD.MASP) >= 3

-- 40. Tìm khách hàng (MAKH, HOTEN) có số lần mua hàng nhiều nhất
SELECT KH.MAKH, HOTEN
FROM KHACHHANG KH, HOADON
WHERE KH.MAKH = HOADON.MAKH
GROUP BY KH.MAKH, HOTEN
HAVING COUNT(*) >= ALL (SELECT COUNT(*)
						FROM HOADON
						GROUP BY MAKH
						)

-- 41. Tháng mấy trong năm 2006, doanh số bán hàng cao nhất
SELECT MONTH(NGHD) THANGDOANHSOCAONHAT
FROM HOADON
WHERE YEAR(NGHD) = 2006
GROUP BY MONTH(NGHD)
HAVING SUM(TRIGIA) >= ALL (SELECT SUM(TRIGIA)
							FROM HOADON
							WHERE YEAR(NGHD) = 2006
							GROUP BY MONTH(NGHD)
							)

-- 42. Tìm sản phẩm (MASP, TENSP) có tổng số lượng bán ra thấp nhất trong năm 2006
SELECT TOP 1 WITH TIES SP.MASP, TENSP
FROM SANPHAM SP, HOADON, CTHD
WHERE SP.MASP = CTHD.MASP
AND HOADON.SOHD = CTHD.SOHD
AND YEAR(NGHD) = 2006
GROUP BY SP.MASP, TENSP
ORDER BY SUM(SL) ASC

-- 43. Mỗi nước sản xuất, tìm sản phẩm (MASP,TENSP) có giá bán cao nhất
SELECT NUOCSX, MASP, TENSP
FROM SANPHAM SP1
WHERE EXISTS (SELECT NUOCSX
				FROM SANPHAM SP2
				GROUP BY NUOCSX
				HAVING SP1.NUOCSX = SP2.NUOCSX
				AND SP1.GIA = MAX(GIA)
				)

-- 44. Tìm nước sản xuất sản xuất ít nhất 3 sản phẩm có giá bán khác nhau
SELECT NUOCSX
FROM SANPHAM
GROUP BY NUOCSX
HAVING COUNT(DISTINCT GIA) >= 3

-- 45. Trong 10 khách hàng có doanh số cao nhất, tìm khách hàng có số lần mua hàng nhiều nhất
SELECT * 
FROM KHACHHANG
WHERE MAKH IN (SELECT TOP 1 WITH TIES HOADON.MAKH
				FROM (SELECT TOP 10 MAKH
					  FROM KHACHHANG
					  ORDER BY DOANHSO DESC) AS B
				JOIN HOADON ON B.MAKH = HOADON.MAKH
				GROUP BY HOADON.MAKH
				ORDER BY COUNT(*) DESC
				)